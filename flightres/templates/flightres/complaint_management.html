{% extends 'flightres/base.html' %}
{% load static %}


{% block body %}
<main class="admin-main">
    <div class="main-card">
        <div class="card-header">
            <h1>CIVILIAN COMPLAINTS / MANAGE CIVILIAN COMPLAINTS</h1>
        </div>
        <div class="card-body">
            <table id="admin-datatable" class="admin-datatable">
                <thead>
                    <tr>
                        <th class="serial-th">SN</th>
                        <th>Date</th>
                        <th>Complaints ID</th>
                        <th>Complaint Category</th>
                        <th>Message</th>
                        <th>Sender Name</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th class="modal-th"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for i, j in data %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><time>{{ i.created_at }}</time></td>
                        <td id="id_uav_uid">ID-{{ i.uav_uid }}</td>
                        <td>{{ i.category }}</td>
                        <td><b>{{ i.message }}</b></td>
                        <td>{{ i.complainer_name }}</td>
                        <td>{{ i.location }}</td>
                        <td><span class="status approved">Solved</span></td>
                        <td>
                            <a id="show-popup" modal-link="complain{{i.uav_uid}}" class="modal-link"><i
                                    class="material-icons" data-toggle="modal"
                                    data-target="#complain{{i.uav_uid}}">chevron_right</i></a>
                            <div class="popup" tabindex="-1" role="dialog" id="complain{{i.uav_uid}}">
                                <div class="popup-container lg-popup map-popup">
                                    <div class="popup-body">
                                        <span class="close-icon"><i class="material-icons">close</i></span>
                                        <div class="popup-header">
                                            <h3>Complaint management for <b>ID {{ i.uav_uid }}</b></h3>

                                        </div>
                                        <div class="popup-content">
                                            <div class="drone-details">
                                                <div class="row gx-md-3 gx-lg-3">
                                                    <div class="col-xl-5 col-sm-12 order-2">
                                                        <div class="info-content col-left">
                                                            <ul>
                                                                <li>
                                                                    <h4>Sender info</h4>
                                                                    <div class="content-list">
                                                                        <p><b>Name:</b><span>{{ i.complainer_name }}</span>
                                                                        </p>
                                                                        <p><b>Location:</b><span>{{ i.location }}</span>
                                                                        </p>
                                                                    </div>
                                                                </li>
                                                                <li>
                                                                    <h4>Additional info</h4>
                                                                    <div class="content-list">
                                                                        <div class="image-content">
                                                                            <figure><img src="{{ i.image_url }}" alt="">
                                                                            </figure>
                                                                        </div>
                                                                </li>
                                                                <li>
                                                                    <h4>Flight Permission Nearby</h4>
                                                                    <div class="permit-list">
                                                                        {% for perm in j %}
                                                                        <p id="expand-perm-pop"
                                                                            modal-link="flight_{{perm.uav_uid}}"
                                                                            class="modal-link"
                                                                            class="escalate-button btn modal-link expandData"
                                                                            data-toggle="modal"
                                                                            data-target="#flight_{{perm.uav_uid}}"
                                                                            value="{{ perm.latitude }}_{{ perm.longitude }}">
                                                                            Permission Request for ID
                                                                            {{ perm.uav_uid }}</p>

                                                                        <div class="popup" id="flight_{{perm.uav_uid}}"
                                                                            tabindex="-1" role="dialog">
                                                                            <div
                                                                                class="popup-container lg-popup map-popup">
                                                                                <div class="popup-body">
                                                                                    <span class="close-icon"><i
                                                                                            class="material-icons">close</i></span>
                                                                                    <div class="popup-header">
                                                                                        <h3>Permission Request for <b>ID
                                                                                                {{ perm.uav_uid }}</b>
                                                                                        </h3>
                                                                                    </div>
                                                                                    <div class="popup-content">
                                                                                        <div class="drone-details">
                                                                                            <div
                                                                                                class="row gx-md-3 gx-lg-3">
                                                                                                <div
                                                                                                    class="col-xl-5 col-sm-12">
                                                                                                    <div
                                                                                                        class="drone-content col-left">
                                                                                                        <ul>
                                                                                                            <li>
                                                                                                                <h4>Operators
                                                                                                                    info
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="content-list">
                                                                                                                    <p>
                                                                                                                        <b>Company
                                                                                                                            Name:</b>
                                                                                                                        <span>{{ perm.uav_uuid.operator.company_name }}</span>
                                                                                                                    </p>
                                                                                                                    <p>
                                                                                                                        <b>Phone
                                                                                                                            Number:</b>
                                                                                                                        <span>{{ perm.uav_uuid.operator.phone_number }}</span>
                                                                                                                    </p>
                                                                                                                    <p>
                                                                                                                        <b>Email:</b>
                                                                                                                        <span>{{ perm.uav_uuid.operator.email }}</span>
                                                                                                                    </p>
                                                                                                                </div>
                                                                                                            </li>
                                                                                                            <br>
                                                                                                            <li>
                                                                                                                <h4>Flight
                                                                                                                    info
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="content-list">
                                                                                                                    <p><b>Start
                                                                                                                            Date:
                                                                                                                        </b><span>{{ perm.flight_start_date }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b>End
                                                                                                                            Date:
                                                                                                                        </b><span>{{ perm.flight_end_date }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b> Time:
                                                                                                                        </b><span>{{ perm.flight_time }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b>Purpose:
                                                                                                                        </b><span>{{ perm.flight_purpose }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b>Aircraft
                                                                                                                            Name:
                                                                                                                        </b><span>{{ perm.uav_uuid.popular_name }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b>Drone
                                                                                                                            Insurance:
                                                                                                                        </b><span><u><a
                                                                                                                                    href="{{ perm.flight_insurance_url }}"
                                                                                                                                    target="_blank">Link
                                                                                                                                    to
                                                                                                                                    document</a></u></span>
                                                                                                                    </p>
                                                                                                                </div>
                                                                                                            </li>
                                                                                                            <br>
                                                                                                            <li>
                                                                                                                <h4>Pilot
                                                                                                                    info
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="content-list">
                                                                                                                    <p><b>Pilot
                                                                                                                            Name:
                                                                                                                        </b><span>{{ perm.pilot_id.name }}
                                                                                                                        </span>
                                                                                                                    <p><b>Pilot
                                                                                                                            Phone
                                                                                                                            Number:
                                                                                                                        </b><span>{{ perm.pilot_id.phone_number }}</span>
                                                                                                                    </p>
                                                                                                                    <p><b>Pilot
                                                                                                                            CV:
                                                                                                                        </b><span><u><a
                                                                                                                                    href="{{ perm.pilot_id.cv_url  }}"
                                                                                                                                    target="_blank">Link
                                                                                                                                    to
                                                                                                                                    CV</a></u></span>
                                                                                                                    </p>
                                                                                                                </div>
                                                                                                            </li>
                                                                                                            <li>
                                                                                                                <h4>Documentation
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="row g-2">
                                                                                                                    <div
                                                                                                                        class="col-md-4">
                                                                                                                        <div
                                                                                                                            class="file-upload">
                                                                                                                            <a href="{{ perm.pilot_id.cv_url  }}"
                                                                                                                                class="file-link">
                                                                                                                                <div
                                                                                                                                    class="file-icon">
                                                                                                                                    <i
                                                                                                                                        class="material-icons">description</i>
                                                                                                                                </div>
                                                                                                                                <div
                                                                                                                                    class="file-info">
                                                                                                                                    <div
                                                                                                                                        class="file-wrap">
                                                                                                                                        <p>Pilot
                                                                                                                                            CV
                                                                                                                                        </p>
                                                                                                                                    </div>
                                                                                                                                </div>
                                                                                                                            </a>
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="col-md-4">
                                                                                                                        <div
                                                                                                                            class="file-upload">
                                                                                                                            <a href="{{ perm.pilot_id.cv_url  }}"
                                                                                                                                class="file-link">
                                                                                                                                <div
                                                                                                                                    class="file-icon">
                                                                                                                                    <i
                                                                                                                                        class="material-icons">description</i>
                                                                                                                                </div>
                                                                                                                                <p>Flight
                                                                                                                                    Plan
                                                                                                                                    URL
                                                                                                                                </p>
                                                                                                                            </a>
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="col-md-4">
                                                                                                                        <div
                                                                                                                            class="file-upload">
                                                                                                                            <a href="#"
                                                                                                                                class="file-link">
                                                                                                                                <div
                                                                                                                                    class="file-icon">
                                                                                                                                    <i
                                                                                                                                        class="material-icons">description</i>
                                                                                                                                </div>
                                                                                                                                <p>Images
                                                                                                                                </p>
                                                                                                                            </a>
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </li>
                                                                                                        </ul>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div
                                                                                                    class="col-xl-7 col-sm-12">
                                                                                                    <div
                                                                                                        class="map-content col-right">
                                                                                                        <div class="tab-content-holder current"
                                                                                                            id="location">
                                                                                                            <div class="map"
                                                                                                                id="map">
                                                                                                                <p id="this_lat"
                                                                                                                    hidden>
                                                                                                                    {{ perm.latitude  }}
                                                                                                                </p>
                                                                                                                <p id="this_lon"
                                                                                                                    hidden>
                                                                                                                    {{ perm.longitude  }}
                                                                                                                </p>
                                                                                                                <p
                                                                                                                    id="this_id"
                                                                                                                    hidden>
                                                                                                                    location-map-{{perm.uav_uid}}
                                                                                                                </p>
                                                                                                                <div id="location-map"
                                                                                                                    style="height: 550px; width: 380px;">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <div
                                                                                                            class="buttons is-end">
                                                                                                            <a href="/np/dashboard/approve_perm/{{ perm.uav_uid }}/approve"
                                                                                                                class="common-button is-bg">Approve</a>
                                                                                                            <a href="/np/dashboard/approve_perm/{{ perm.uav_uid }}/deny"
                                                                                                                class="common-button is-border cancel-button">Deny</a>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <div class="col-xl-7 col-sm-12  order1">
                                                        <div class="complaint-content col-right">
                                                            <h3 class="title">COMPLAINT MESSAGE <span><a
                                                                        class="common-button is-bg"
                                                                        href="{% url 'dashboard:update-complain' pk=i.uav_uid action='status' %}">Mark
                                                                        as Resolved</a> </span></h3>
                                                            <div class="info-para">
                                                                <h6>Complain Category:
                                                                    <span>{{ i.category }}</span></h6>
                                                                <span class="time">{{ i.created_at }}</span>
                                                            </div>
                                                            <div class="info-block">
                                                                <p>{{ i.message }}</p>
                                                            </div>
                                                            <div class="button-wrap">
                                                                <button class="common-button is-bg escalate-button"
                                                                    popup-link="open-modal-escalated">Issue
                                                                    Escalated</button>
                                                            </div>
                                                            <form action="{% url 'dashboard:submit-reply' pk=i.pk %}"
                                                                method="POST">
                                                                {% csrf_token %}
                                                                <textarea class="form-control" id="note" type="text"
                                                                    name="note">{{ i.note }}</textarea>
                                                                <div class="textarea-message">
                                                                    <textarea class="form-control" id="reply"
                                                                        type="text"
                                                                        name="reply">{{ i.reply }}</textarea>
                                                                </div>
                                                                <br>
                                                                <div class="buttons is-end">
                                                                    <button type="submit"
                                                                        class="common-button is-bg">Reply</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="popup-footer popup-permission">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="popup" id="open-modal-escalated">
                                <div class="popup-container sm-popup map-popup">
                                    <div class="popup-body">
                                        <span class="close-icon"><i class="material-icons">close</i></span>
                                        <div class="popup-header">
                                            <h3>Escalate Issue</h3>

                                        </div>
                                        <div class="popup-content">
                                            <div class="drone-details">
                                                <div class="row">
                                                    <div class="col-xl-12 col-sm-12">
                                                        <div class="drone-content col-left">
                                                            <ul>
                                                                <li>
                                                                    <h4>Police Contacts</h4>
                                                                    <div class="content-list">
                                                                        <p><b>Kathmandu</b><span>(009)036-3782</span>
                                                                        </p>
                                                                        <p><b>Lima</b><span>(195)362-6460</span>
                                                                        </p>
                                                                        <p><b>Amsterdam</b><span>(195)362-6460</span>
                                                                        </p>
                                                                        <p><b>Shenzen</b><span>(195)362-6460</span>
                                                                        </p>
                                                                        <p><b>Helsinki</b><span>(195)362-6460</span>
                                                                        </p>
                                                                    </div>
                                                                    <div class="button-wrap">
                                                                        <a class="common-button is-bg"
                                                                            href="{% url 'dashboard:update-complain' pk=i.uav_uid action='escalate' %}">Escalate</a>
                                                                    </div>
                                                                </li>
                                                            </ul>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="popup-footer popup-permission">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>
{% endblock body %}

{% block footer_links %}
<script type="text/javascript">
    var flight_objects = '{{ json_data }}'
</script>

<script src="{% static 'js/map.js' %}"></script>
<script>
    $("#expand-perm-pop").click(function () {
        // var lat = $("#this_lat").text();
        // var lon = $("#this_lon").text();
        // var map_id = $("#this_id").text();
        // console.log(lat, lon, map_id);

        var expandBtn = document.getElementsByClassName('expandData')
        print(expandBtn)

        for (var i = 0; i < expandBtn.length; i++) {
        expandBtn[i].addEventListener('click', function (e) {
            // console.log('clicked');
            var lat = e.target.value.split('_')[1]
            var lon = e.target.value.split('_')[2]
            
            var map = L.map("location-map").setView([lat, lon], 15);
        console.log(map)

        var mark = L.marker([lat, lon], 15).addTo(map);

        var circle = L.circle([lat, lon], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 100
        }).addTo(map);

        osm = L.tileLayer('https://api.mapbox.com/styles/v1/upendraoli/cjuvfcfns1q8r1focd0rdlgqn/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoidXBlbmRyYW9saSIsImEiOiJjaWYwcnFnNmYwMGY4dGZseWNwOTVtdW1tIn0.uhY72SyqmMJNTKa0bY-Oyw', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        })

        googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);
        googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });


        var baseLayers = {
            "OpenStreetMap": osm,
            "Google Streets": googleStreets,
            "Google Hybrid": googleHybrid,
            "Google Satellite": googleSat,
            "Google Terrain": googleTerrain,

        };

        layerswitcher = L.control.layers(baseLayers, {}, { collapsed: true }).addTo(map);

    });
        })
    }


</script>
{% endblock footer_links %}